# 카카오페이 뿌리기 기능 구현하기

카카오페이에 있는 머니 뿌리기 기능을 구현하는 REST API를 구현하는 것이다. UI 및 메세지 영역을 제외하고 간소화된 API를 제공하면 된다. 

## 시스템 요구사항

**기능적인 요구사항:**

- 사용자는 대화방에 원하는 금액을 원하는 인원만큼에게 돈을 뿌릴 수 있다.
- 돈을 뿌리는 대상, 돈이 분배되는 금액은 정할 수 없다.
- 뿌리기는 받는 대상은 한번만 받을 수 있다.
- 돈을 뿌린 자신은 돈을 받을 수 없다.
- 대화방에 속한 사람만 뿌리기를 받을 수 있다. 만료 후에는 받을 수 없다.
- 뿌린 건은 10분간만 유효하다.

**비기능적인 요구사항:**

- Token은 3자리 문자열로 구성되며 예측이 불가능해야한다.
- 뿌릴 금액의 분배는 랜덤으로 정해진다.

**확장된 요구사항:**

- 다수의 서버에 다수의 인스턴스로 동작하더라도 기능에는 문제가 없도록 한다.
- 뿌리기의 잔액은 무제한으로 한다.

## 시스템 API

- 돈뿌리기: [http://localhost:8080/throw-moneys](http://localhost:8080/throw-moneys)
- 돈받기:  [http://localhost:8080/throw-moneys/{Token}/take](http://localhost:8080/throw-moneys/mYt/take)
- 조회: [http://localhost:8080/throw-moneys/](http://localhost:8080/throw-moneys/jgm){Token}

## 주요기능 문제 해결 전략

### 토큰 문자열 생성

문자열은 3자리 내에서 최대한 많은 문자열을 조합할 수 있어야 합니다. 대문자(A~Z) + 소문자(a~z) + 숫자(0~9) 를 모두 구분하여 한자리에 62가지를 갖을 수 있도록 조합하였습니다.  이 조합으로 생성할 수 있는 최대 개수는 62 * 62 * 62 = 238,328개 입니다. 이 방식에 따라 하나의 대화방에서 238,328개의 토큰을 생성할 수 있습니다. 토큰은 10분의 제한 시간을 갖고 있습니다. 따라서 최대 10분이내에 238,328개의 돈뿌리기를 할 수 있게 됩니다. 

최대치를 늘리기 위해서는 문자열에 특수문자를 포함하거나, 문자열을 늘리거나 할 수 있습니다. 

### 인원수에 맞는 돈 분배

입력되는 인원에 따라 금액을 나누게 됩니다. 예를 들어 5명에게 `10000`원을 뿌리게 하였다면 

1. 첫번째에는 할당에서는 남은 인원의 4를 뺀 금액인 996. 즉, 1~996의 숫자를 랜덤으로 할당 받게됩니다. 예시로 `1328`를 할당 받았다고 
2. 전체금액에서 첫번째가 할당받은 금액을 제외한 금액 8672원을 다시 남은 인원인 3을 뺀 1~ 8669원을 랜덤으로 할당 합니다. 

이런 방식으로 남은 인원의 금액(최소 1원)을 제외하고 할당된 금액을 뺀 나머지를 랜덤으로 분배하게 구성하였습니다.

### 돈 받기

돈을 받기 위해서는 먼저 해당 대화방에 토큰을 이용하여 확인을 사항들이 있습니다.

1. 대화방에 토큰이 존재 하는가?
2. 뿌린 정보가 있다고 하면 시간이 만료된 돈뿌리기는 아닌가?
3. 이미 모두 뿌려진 돈뿌리기는 아닌가? 
4. 내가 뿌린돈을 내가 받으려고 하는 것은 아닌가?

위의 4가지 사항을 확인 하며 문제가 없다면 돈을 받을 수 있도록 합니다. 

### 토큰 만료

토큰이 생성된때는 만료시간을 갖게 됩니다. 해당 만료 시간이 10분이 넘었다면 돈받을 수 없는 돈뿌리기가 됩니다. 조회를 위해서는 이 만료시간이 7일이전이라면 조회가 가능하지만, 조회하는 시간이 만료시간의 7일 이후라면 더이상 조회를 할 수없게 됩니다.